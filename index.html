<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solar Advisor – Telangana LT Domestic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #fff8e1 0, #fffde7 40%, #fffaf0 100%);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .app-container {
      background: #ffffff;
      width: 98%;
      max-width: 820px;
      margin: 16px;
      padding: 18px 20px 22px;
      border-radius: 18px;
      border: 1px solid #ffe0b2;
      box-shadow: 0 8px 24px rgba(255, 171, 64, 0.25);
    }

    h1 {
      text-align: center;
      font-size: 1.5rem;
      color: #e65100;
      margin-bottom: 4px;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #8d6e63;
      margin-bottom: 16px;
    }

    /* LANGUAGE TOGGLE */
    .lang-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
      font-size: 0.9rem;
      color: #4e342e;
    }
    .lang-toggle button {
      padding: 4px 10px;
      border-radius: 100px;
      border: 1px solid #ffb74d;
      background: #fff3e0;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .lang-toggle button.active {
      background: #ff9800;
      color: white;
      border-color: #ef6c00;
    }

    /* FORM UI */
    .flex-row { display: flex; flex-wrap: wrap; gap: 10px; }
    .form-group { flex: 1 1 140px; }
    .form-group.wide { flex: 1 1 100%; }

    label {
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #4e342e;
      display: block;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #ffcc80;
      background: #fffdf7;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #ff9800;
      box-shadow: 0 0 0 2px rgba(255,167,38,0.3);
    }

    textarea { resize: vertical; min-height: 60px; }

    .months-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .month-card {
      background: linear-gradient(145deg, #fff8e1, #fff3e0);
      padding: 10px;
      border: 1px solid #ffe0b2;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(255,167,38,0.2);
    }

    .month-title {
      color: #ef6c00;
      font-size: 0.85rem;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .btn-row {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 100px;
      background: linear-gradient(135deg, #ff9800, #ef6c00);
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(245, 124, 0, 0.35);
    }
    button:hover {
      background: linear-gradient(135deg, #fb8c00, #d84315);
    }

    .error { color: #b00020; margin-top: 4px; font-size: 0.85rem; }

    @media (max-width: 600px) {
      .app-container { margin: 8px; padding: 14px 12px 18px; }
    }
  </style>
</head>

<body>
  <div class="app-container">

    <h1>Solar Advisor – Telangana</h1>
    <div class="subtitle">LT-I Domestic Consumption & Solar Recommendation</div>

    <!-- LANGUAGE TOGGLE -->
    <div class="lang-toggle">
      <span id="langLabel">Language / భాష:</span>
      <button type="button" onclick="setLanguage('en')" id="btnLangEn">English</button>
      <button type="button" onclick="setLanguage('te')" id="btnLangTe">తెలుగు</button>
    </div>

    <!-- INPUT FIELDS -->
    <div class="flex-row">
      <div class="form-group">
        <label id="labelConsumerName" for="consumerName">Consumer Name</label>
        <input id="consumerName" type="text" placeholder="e.g., Sri Xxxx">
      </div>

      <div class="form-group">
        <label id="labelServiceNo" for="serviceNo">Service No.</label>
        <input id="serviceNo" type="text" placeholder="08101-XXXXX">
      </div>

      <div class="form-group wide">
        <label id="labelAddress" for="address">Address</label>
        <textarea id="address" placeholder="House No., Street, Village"></textarea>
      </div>
    </div>

    <div class="flex-row">
      <div class="form-group">
        <label id="labelLoadKw" for="loadKw">Sanctioned Load (kW)</label>
        <input id="loadKw" type="number" step="0.1">
      </div>

      <div class="form-group">
        <label id="labelMonthCount" for="monthCount">No. of Months (1–12)</label>
        <select id="monthCount"></select>
      </div>

      <div class="form-group">
        <label id="labelSolarKwInput" for="solarKwInput">Customer Solar Choice (kW)</label>
        <input id="solarKwInput" type="number" step="0.1">
      </div>
    </div>

    <label id="labelMonthUnits">Enter Monthly Consumption (Units)</label>

    <div class="months-grid" id="monthsGrid"></div>

    <div class="btn-row">
      <button id="resetBtn">Clear All</button>
      <button id="calcBtn">Calculate & Open Summary</button>
    </div>

    <div id="error" class="error"></div>

  </div>

<script>
/* ----------------- LANGUAGE STRINGS --------------------- */

const langTexts = {
  en: {
    consumerName: "Consumer Name",
    serviceNo: "Service No.",
    address: "Address",
    loadKw: "Sanctioned Load (kW)",
    monthCount: "No. of Months (1–12)",
    solarKwInput: "Customer Solar Choice (kW)",
    monthUnits: "Enter Monthly Consumption (Units)",
    langLabel: "Language / భాష:"
  },

  te: {
    consumerName: "వినియోగదారుని పేరు",
    serviceNo: "సర్వీస్ నంబర్",
    address: "చిరునామా",
    loadKw: "సంక్షన్ లోడ్ (kW)",
    monthCount: "నెలల సంఖ్య (1–12)",
    solarKwInput: "వినియోగదారుడు ఎంచుకున్న సోలార్ పరిమాణం (kW)",
    monthUnits: "ప్రతి నెల వినియోగించిన యూనిట్లు నమోదు చేయండి",
    langLabel: "భాష / Language:"
  }
};

function setLanguage(lang) {
  const t = langTexts[lang];
  document.getElementById("labelConsumerName").innerText = t.consumerName;
  document.getElementById("labelServiceNo").innerText = t.serviceNo;
  document.getElementById("labelAddress").innerText = t.address;
  document.getElementById("labelLoadKw").innerText = t.loadKw;
  document.getElementById("labelMonthCount").innerText = t.monthCount;
  document.getElementById("labelSolarKwInput").innerText = t.solarKwInput;
  document.getElementById("labelMonthUnits").innerText = t.monthUnits;
  document.getElementById("langLabel").innerText = t.langLabel;

  document.getElementById("btnLangEn").classList.toggle("active", lang === "en");
  document.getElementById("btnLangTe").classList.toggle("active", lang === "te");
}

// default language
setLanguage("en");

/* ----------------- BILLING SLABS ------------------------ */

const slabs = [
  { label: "0–50",    limit: 50,  rate: 1.95 },
  { label: "51–100",  limit: 100, rate: 3.10 },
  { label: "101–200", limit: 200, rate: 4.80 },
  { label: "201–300", limit: 300, rate: 7.70 },
  { label: "301–400", limit: 400, rate: 9.00 },
  { label: "401–800", limit: 800, rate: 9.50 },
  { label: ">800",    limit: Infinity, rate: 10.00 }
];

const FIXED_RATE_PER_KW = 10;
const UNITS_PER_KW_PER_MONTH = 120;
const SOLAR_COST_PER_KW = 65000;
const MAX_MONTHS = 12;

const monthNames = [
  "Month 1", "Month 2", "Month 3", "Month 4",
  "Month 5", "Month 6", "Month 7", "Month 8",
  "Month 9", "Month 10", "Month 11", "Month 12"
];

function formatAmount(x) {
  return "₹" + x.toFixed(2);
}

/* ------------------ UI INIT ---------------------------- */

function initUI() {
  const monthCountSelect = document.getElementById("monthCount");
  const monthsGrid = document.getElementById("monthsGrid");

  // Month count select
  for (let i = 1; i <= MAX_MONTHS; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = i;
    monthCountSelect.appendChild(opt);
  }
  monthCountSelect.value = "12";

  // Month cards
  for (let i = 0; i < MAX_MONTHS; i++) {
    const card = document.createElement("div");
    card.className = "month-card";
    card.dataset.index = i;

    const title = document.createElement("div");
    title.className = "month-title";
    title.textContent = monthNames[i];

    const label = document.createElement("label");
    label.textContent = "Units";

    const input = document.createElement("input");
    input.type = "number";
    input.min = "0";
    input.placeholder = "e.g. 250";
    input.id = "units_" + (i + 1);

    card.appendChild(title);
    card.appendChild(label);
    card.appendChild(input);
    monthsGrid.appendChild(card);
  }

  // Show/hide cards per month count
  monthCountSelect.addEventListener("change", () => {
    const count = Number(monthCountSelect.value);
    const cards = monthsGrid.querySelectorAll(".month-card");
    cards.forEach((card, idx) => {
      card.style.display = idx < count ? "block" : "none";
    });
  });

  monthCountSelect.dispatchEvent(new Event("change"));
}

initUI();

/* ---------------- BILL CALC --------------------------- */

function calculateSingleMonthBill(units, loadKw) {
  let remaining = units;
  let previousLimit = 0;
  let energyTotal = 0;

  for (const slab of slabs) {
    if (remaining <= 0) break;

    const slabUpper = slab.limit;
    const slabUnits = Math.max(
      0,
      Math.min(units, slabUpper) - previousLimit
    );

    if (slabUnits > 0) {
      const amount = slabUnits * slab.rate;
      energyTotal += amount;
    }

    previousLimit = slabUpper;
    remaining = units - previousLimit;
  }

  const fixedCharges = loadKw * FIXED_RATE_PER_KW;
  const grandTotal = energyTotal + fixedCharges;

  return { energyTotal, fixedCharges, grandTotal };
}

/* ---------------- MAIN CALC ---------------------------- */

document.getElementById("calcBtn").addEventListener("click", calculateAndOpenSummary);
document.getElementById("resetBtn").addEventListener("click", clearAllInputs);

function clearAllInputs() {
  document.getElementById("loadKw").value = "";
  document.getElementById("solarKwInput").value = "";
  document.getElementById("consumerName").value = "";
  document.getElementById("serviceNo").value = "";
  document.getElementById("address").value = "";
  for (let i = 1; i <= MAX_MONTHS; i++) {
    const input = document.getElementById("units_" + i);
    if (input) input.value = "";
  }
  document.getElementById("error").textContent = "";
}

function calculateAndOpenSummary() {
  const loadKwInput = document.getElementById("loadKw");
  const monthCountSelect = document.getElementById("monthCount");
  const solarKwInput = document.getElementById("solarKwInput");
  const errorDiv = document.getElementById("error");

  errorDiv.textContent = "";

  const monthCount = Number(monthCountSelect.value);
  const loadKw = Number(loadKwInput.value || 0);

  if (!Number.isFinite(loadKw) || loadKw < 0) {
    errorDiv.textContent = "Please enter a valid non-negative sanctioned load (kW).";
    return;
  }

  let anyMonthFilled = false;
  let totalUnits = 0;
  let totalEnergy = 0;
  let totalFixed = 0;
  let totalGrand = 0;
  let monthsWithData = 0;
  const rows = [];

  for (let i = 1; i <= monthCount; i++) {
    const input = document.getElementById("units_" + i);
    const raw = input.value.trim();

    if (raw === "") continue;

    const units = Number(raw);
    if (!Number.isFinite(units) || units < 0) {
      errorDiv.textContent = "Invalid units in " + monthNames[i - 1] + ". Please check.";
      return;
    }

    anyMonthFilled = true;
    const { energyTotal, fixedCharges, grandTotal } =
      calculateSingleMonthBill(units, loadKw);

    totalUnits += units;
    totalEnergy += energyTotal;
    totalFixed += fixedCharges;
    totalGrand += grandTotal;
    monthsWithData++;

    rows.push({
      month: monthNames[i - 1],
      units: units,
      energy: energyTotal,
      fixed: fixedCharges,
      total: grandTotal
    });
  }

  if (!anyMonthFilled) {
    errorDiv.textContent = "Please enter units for at least one month.";
    return;
  }

  const avgUnits = totalUnits / monthsWithData;
  const avgBill = totalGrand / monthsWithData;

  // Consumer info
  const nameVal = document.getElementById("consumerName").value.trim() || "—";
  const serviceVal = document.getElementById("serviceNo").value.trim() || "—";
  const addrVal = document.getElementById("address").value.trim() || "—";

  // Solar calculation
  const recommendedRaw = avgUnits / UNITS_PER_KW_PER_MONTH;
  const recommendedKw = recommendedRaw > 0
    ? Math.max(1, Math.round(recommendedRaw * 2) / 2)
    : 0;

  let chosenKw = Number(solarKwInput.value || 0);
  if (!(chosenKw > 0) && recommendedKw > 0) {
    chosenKw = recommendedKw;
  }

  const recUnitsOffset = recommendedKw * UNITS_PER_KW_PER_MONTH;
  const chosenUnitsOffset = chosenKw * UNITS_PER_KW_PER_MONTH;

  const recGross = recommendedKw * SOLAR_COST_PER_KW;
  const recSubsidy = calculateSubsidy(recommendedKw);
  const recNet = Math.max(0, recGross - recSubsidy);

  const chosenGross = chosenKw * SOLAR_COST_PER_KW;
  const chosenSubsidy = calculateSubsidy(chosenKw);
  const chosenNet = Math.max(0, chosenGross - chosenSubsidy);

  let recSavingFraction = 0;
  let chosenSavingFraction = 0;
  if (recommendedRaw > 0) {
    recSavingFraction = Math.min(1, recommendedKw / recommendedRaw);
    chosenSavingFraction = Math.min(1, chosenKw / recommendedRaw);
  }

  const recMonthlySaving = avgBill * recSavingFraction;
  const chosenMonthlySaving = avgBill * chosenSavingFraction;

  let recPaybackText = "–";
  if (recMonthlySaving > 0 && recNet > 0) {
    const years = recNet / (recMonthlySaving * 12);
    recPaybackText = years.toFixed(1) + " years";
  }

  let chosenPaybackText = "–";
  if (chosenMonthlySaving > 0 && chosenNet > 0) {
    const years = chosenNet / (chosenMonthlySaving * 12);
    chosenPaybackText = years.toFixed(1) + " years";
  }

  // Comparison text
  let comparisonLine = "";
  if (chosenKw === recommendedKw) {
    comparisonLine =
      `You have chosen <strong>${chosenKw.toFixed(1)} kW</strong>, which is the same as the recommended size based on your average consumption.`;
  } else if (chosenKw > recommendedKw) {
    comparisonLine =
      `You have chosen <strong>${chosenKw.toFixed(1)} kW</strong>, which is slightly higher than the recommended <strong>${recommendedKw.toFixed(1)} kW</strong>. This can give more savings and better coverage for future load increase.`;
  } else {
    comparisonLine =
      `You have chosen <strong>${chosenKw.toFixed(1)} kW</strong>, which is lower than the recommended <strong>${recommendedKw.toFixed(1)} kW</strong>. Monthly savings and payback will be proportionally lower.`;
  }

  // Sanctioned load notes (English + Telugu)
  let loadNote = "";
  const targetKw = Math.max(chosenKw, recommendedKw);

  if (!(loadKw > 0)) {
    loadNote =
      "Sanctioned load is not entered. As per TGNPDCL practice, sanctioned load (in kW) should generally be at least equal to the proposed rooftop solar plant capacity (in kW). Consumer may be advised to verify and enhance the sanctioned load accordingly.";
  } else if (!(targetKw > 0)) {
    loadNote =
      `Present sanctioned load is ${loadKw.toFixed(1)} kW. As per TGNPDCL practice, sanctioned load should generally be at least equal to the proposed rooftop solar plant capacity.`;
  } else if (loadKw + 1e-6 >= targetKw) {
    loadNote =
      `Present sanctioned load is ${loadKw.toFixed(1)} kW, which is adequate for a solar plant of about ${targetKw.toFixed(1)} kW as per TGNPDCL practice (sanctioned load ≥ solar capacity).`;
  } else {
    loadNote =
      `Present sanctioned load is ${loadKw.toFixed(1)} kW, which is lower than the proposed/recommended solar capacity of about ${targetKw.toFixed(1)} kW. As per TGNPDCL norms, consumer may be advised to apply for sanctioned load enhancement to at least ${targetKw.toFixed(1)} kW before installing the rooftop solar plant.`;
  }

  let loadNoteTe = "";
  if (!(loadKw > 0)) {
    loadNoteTe =
      "మీ సంక్షన్ లోడ్ నమోదు చేయలేదు. TGNPDCL ప్రకారం, సోలార్ ప్లాంట్ పరిమాణం (kW) కు సమానంగా లేదా ఎక్కువగా సంక్షన్ లోడ్ ఉండాలి. కాబట్టి దయచేసి మీ ప్రస్తుత సంక్షన్ లోడ్ ని తనిఖీ చేసి అవసరమైతే పెంచుకోవాలి.";
  } else if (!(targetKw > 0)) {
    loadNoteTe =
      `మీ ప్రస్తుత సంక్షన్ లోడ్: ${loadKw.toFixed(1)} kW. TGNPDCL ప్రకారం సోలార్ ప్లాంట్ పరిమాణం కు సమానంగా ఉండాలి. దయచేసి తనిఖీ చేయండి.`;
  } else if (loadKw >= targetKw) {
    loadNoteTe =
      `మీ ప్రస్తుత సంక్షన్ లోడ్: ${loadKw.toFixed(1)} kW, సోలార్ సామర్థ్యం: ${targetKw.toFixed(1)} kW. TGNPDCL నిబంధనల ప్రకారం ఇది సరిపోతుంది.`;
  } else {
    loadNoteTe =
      `మీ ప్రస్తుత సంక్షన్ లోడ్: ${loadKw.toFixed(1)} kW; మీ సోలార్ అవసరం: ${targetKw.toFixed(1)} kW. సంక్షన్ లోడ్ తక్కువగా ఉంది, కాబట్టి ముందుగా Load Enhancement కోసం దరఖాస్తు చేయాలి.`;
  }

  // Build month rows HTML
  let rowsHtml = "";
  rows.forEach(r => {
    rowsHtml += `
      <tr>
        <td>${r.month}</td>
        <td>${r.units}</td>
        <td>${r.energy.toFixed(2)}</td>
        <td>${r.fixed.toFixed(2)}</td>
        <td>${r.total.toFixed(2)}</td>
      </tr>`;
  });

  // SUMMARY HTML PAGE
  const summaryHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solar & Billing Summary</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #fff8e1;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .sheet {
      max-width: 210mm;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 0;
      border: 1px solid #ffe0b2;
      box-shadow: none;
      padding: 15mm;
    }
    h1 {
      text-align: center;
      margin: 0 0 4px;
      font-size: 1.4rem;
      color: #e65100;
    }
    h2 {
      margin: 12px 0 6px;
      font-size: 1rem;
      color: #bf360c;
    }
    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #8d6e63;
      margin-bottom: 10px;
    }
    .consumer-block {
      font-size: 0.85rem;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px dashed #ffe0b2;
    }
    .consumer-block div { margin-bottom: 2px; }
    .label { font-weight: 600; color: #4e342e; }
    .value { color: #3e2723; }

    .highlight-pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 700;
      background: #fff3e0;
      border: 1px solid #ffc107;
      color: #e65100;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 6px;
      background: #fffdf7;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ffe0b2;
      padding: 4px 4px;
      text-align: right;
    }
    th {
      background: linear-gradient(135deg, #ffe0b2, #ffcc80);
      color: #4e342e;
      font-weight: 700;
    }
    th:first-child, td:first-child {
      text-align: left;
    }

    .totals {
      margin-top: 8px;
      font-size: 0.85rem;
      background: #fff8e1;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #ffe082;
    }
    .totals-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }
    .totals-row span.label { color: #5d4037; }
    .totals-row span.value { color: #e65100; font-weight: 700; }

    .badge {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 4px;
      white-space: nowrap;
    }
    .badge-green {
      background: #dcedc8;
      color: #33691e;
      border: 1px solid #c5e1a5;
    }
    .badge-amber {
      background: #ffe082;
      color: #e65100;
      border: 1px solid #ffca28;
    }

    .solar-box {
      margin-top: 8px;
      padding: 8px;
      border-radius: 12px;
      background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
      border: 1px solid #c5e1a5;
      font-size: 0.82rem;
    }
    .solar-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }
    .solar-label { color: #33691e; }
    .solar-value { color: #1b5e20; font-weight: 700; }

    .compare-text {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #4e342e;
    }

    .note {
      margin-top: 8px;
      font-size: 0.75rem;
      color: #6d4c41;
      background: #fff3e0;
      border-left: 4px solid #ffb300;
      padding: 6px 8px;
      border-radius: 6px;
    }

    .payback-note {
      margin-top: 8px;
      padding: 8px;
      border-radius: 12px;
      border: 1px dashed #ffb74d;
      background: #fff8e1;
      font-size: 0.78rem;
    }
    .payback-box {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 6px;
    }
    .pb {
      flex: 1 1 260px;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid #ffe0b2;
      background: #fffdf3;
    }

    .top-actions {
      text-align: right;
      margin-bottom: 6px;
    }
    .print-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ffb300, #f57c00);
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
    }

    @media print {
      body { background: #ffffff; }
      .sheet { box-shadow: none; border-radius: 0; margin: 0; }
      .top-actions { display: none; }
    }

    @page {
      size: A4;
      margin: 15mm;
    }
  </style>
</head>
<body>
  <div class="sheet">
    <div class="top-actions">
      <button class="print-btn" onclick="window.print()">Print</button>
    </div>
    <h1>Solar & Billing Summary</h1>
    <div class="subtitle">Based on your past consumption and Telangana LT-I domestic tariff</div>

    <div class="consumer-block">
      <div><span class="label">Consumer Name:</span> <span class="value">${nameVal}</span></div>
      <div><span class="label">Service No.:</span> <span class="value">${serviceVal}</span></div>
      <div><span class="label">Address:</span> <span class="value">${addrVal}</span></div>
      <div class="highlight-pill">
        Avg: ${avgUnits.toFixed(1)} units / month ≈ ${formatAmount(avgBill)} / month
      </div>
    </div>

    <h2>Month-wise Consumption & Bill</h2>
    <table>
      <thead>
        <tr>
          <th>Month</th>
          <th>Units</th>
          <th>Energy (₹)</th>
          <th>Fixed (₹)</th>
          <th>Total (₹)</th>
        </tr>
      </thead>
      <tbody>
        ${rowsHtml}
      </tbody>
    </table>

    <div class="totals">
      <div class="totals-row">
        <span class="label">Total units (all entered months)</span>
        <span class="value">${totalUnits.toFixed(0)}</span>
      </div>
      <div class="totals-row">
        <span class="label">Total energy charges</span>
        <span class="value">${formatAmount(totalEnergy)}</span>
      </div>
      <div class="totals-row">
        <span class="label">Total fixed charges</span>
        <span class="value">${formatAmount(totalFixed)}</span>
      </div>
      <div class="totals-row">
        <span class="label">Grand total (before duty/FSA)</span>
        <span class="value">${formatAmount(totalGrand)}</span>
      </div>
      <div class="totals-row">
        <span class="label">Average units per month</span>
        <span class="value">${avgUnits.toFixed(1)}</span>
      </div>
      <div class="totals-row">
        <span class="label">Average bill per month</span>
        <span class="value">${formatAmount(avgBill)}</span>
      </div>
    </div>

    <h2>Solar Recommendation & Savings</h2>
    <div class="badge badge-green">Recommended Solar Size & Savings</div>
    <div class="solar-box">
      <div class="solar-row">
        <span class="solar-label">Recommended size (from avg units):</span>
        <span class="solar-value">${recommendedKw.toFixed(1)} kW</span>
      </div>
      <div class="solar-row">
        <span class="solar-label">Approx. units generated / month:</span>
        <span class="solar-value">${recUnitsOffset.toFixed(0)} units</span>
      </div>
      <div class="solar-row">
        <span class="solar-label">Gross cost (@ ₹65,000 / kW):</span>
        <span class="solar-value">${formatAmount(recGross)}</span>
      </div>
      <div class="solar-row">
        <span class="solar-label">Govt subsidy:</span>
        <span class="solar-value">${formatAmount(recSubsidy)}</span>
      </div>
      <div class="solar-row">
        <span class="solar-label">Net cost after subsidy:</span>
        <span class="solar-value">${formatAmount(recNet)}</span>
      </div>
      <div class="solar-row">
        <span class="solar-label">Approx. monthly saving in bill:</span>
        <span class="solar-value">${formatAmount(recMonthlySaving)}</span>
      </div>
      <div class="solar-row">
        <span class="solar-label">Simple payback period:</span>
        <span class="solar-value">${recPaybackText}</span>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="badge badge-amber">Customer Chosen Solar</div>
      <div class="solar-box" style="background:linear-gradient(135deg,#fffde7,#fff8e1);border-color:#ffca28;">
        <div class="solar-row">
          <span class="solar-label">Customer chosen size:</span>
          <span class="solar-value">${chosenKw.toFixed(1)} kW</span>
        </div>
        <div class="solar-row">
          <span class="solar-label">Approx. units generated / month:</span>
          <span class="solar-value">${chosenUnitsOffset.toFixed(0)} units</span>
        </div>
        <div class="solar-row">
          <span class="solar-label">Gross cost (@ ₹65,000 / kW):</span>
          <span class="solar-value">${formatAmount(chosenGross)}</span>
        </div>
        <div class="solar-row">
          <span class="solar-label">Govt subsidy:</span>
          <span class="solar-value">${formatAmount(chosenSubsidy)}</span>
        </div>
        <div class="solar-row">
          <span class="solar-label">Net cost after subsidy:</span>
          <span class="solar-value">${formatAmount(chosenNet)}</span>
        </div>
        <div class="solar-row">
          <span class="solar-label">Approx. monthly saving in bill:</span>
          <span class="solar-value">${formatAmount(chosenMonthlySaving)}</span>
        </div>
        <div class="solar-row">
          <span class="solar-label">Simple payback period:</span>
          <span class="solar-value">${chosenPaybackText}</span>
        </div>
      </div>
    </div>

    <div class="compare-text">
      ${comparisonLine}
    </div>

    <div class="note">
      <strong>Note (English):</strong><br/>
      Billing is based on LT-I domestic slabs and fixed charge of ₹10/kW.
      Electricity duty, FSA and other surcharges are not included.
      Solar generation assumed as ~120 units/month per kW. Subsidy slab:
      1 kW → ₹30,000; 2 kW → ₹50,000; 3 kW & above → ₹78,000.
      <br/><br/>
      <strong>Sanctioned Load Advisory (TGNPDCL):</strong> ${loadNote}
      <br/><br/>
      <strong style="color:#bf360c;">గమనిక (తెలుగు):</strong><br/>
      బిల్లింగ్ TGNPDCL LT-I డొమెస్టిక్ స్లాబ్‌ల ప్రకారమే గణన చేయబడింది.
      సంక్షన్ లోడ్‌కు ప్రతి kW పై ₹10 స్థిర చార్జీ పరిగణనలోకి తీసుకున్నారు.
      విద్యుత్ చెల్లింపుల్లో Duty, FSA వంటివి ఇందులో కలుపలేదు.
      సోలార్ జనరేషన్ సగటుగా 1 kW = 120 యూనిట్లు / నెలగా పరిగణించారు.
      సబ్సిడీ: 1 kW → ₹30,000; 2 kW → ₹50,000; 3 kW మరియు పైగా → ₹78,000.
      <br/><br/>
      <strong>సంక్షన్ లోడ్ సూచన (TGNPDCL):</strong> ${loadNoteTe}
    </div>

    <div class="payback-note">
      <strong>Solar Payback – English & తెలుగు</strong>
      <div class="payback-box">
        <div class="pb">
          <b>Solar Payback – Simple Explanation (English)</b>
          <ul>
            <li>Every month, rooftop solar replaces units you would have taken from TGNPDCL.</li>
            <li>This reduction in bill is your <strong>monthly saving</strong>.</li>
            <li>Net solar cost = System cost – Govt subsidy.</li>
            <li><strong>Simple payback (years) = Net solar cost ÷ (Monthly saving × 12)</strong></li>
            <li>After payback, solar electricity is almost free for 20–25 years.</li>
          </ul>
        </div>
        <div class="pb">
          <b>సోలార్ పేయ్‌బ్యాక్ – సులభమైన తెలుగు వివరణ</b>
          <ul>
            <li>ప్రతి నెల సోలార్ ద్వారా ఉత్పత్తి అయ్యే యూనిట్లు మీ TGNPDCL బిల్లు యూనిట్లను తగ్గిస్తాయి.</li>
            <li>బిల్లు తగ్గడం ద్వారా లభించే మొత్తం మీ <strong>మంత్లీ సేవింగ్</strong>.</li>
            <li>నెట్ సోలార్ ఖర్చు = సిస్టమ్ మొత్తం ఖర్చు – ప్రభుత్వం సబ్సిడీ.</li>
            <li><strong>పేయ్‌బ్యాక్ సంవత్సరాలు = నెట్ ఖర్చు ÷ (మంత్లీ సేవింగ్ × 12)</strong></li>
            <li>ఈ కాలం తర్వాత మిగిలిన 20–25 సంవత్సరాలు విద్యుత్ దాదాపు ఉచితం (చిన్న మెయింటెనెన్స్ తప్ప).</li>
          </ul>
        </div>
      </div>
    </div>

  </div>
</body>
</html>
  `;

  const win = window.open("", "_blank");
  win.document.open();
  win.document.write(summaryHtml);
  win.document.close();
}

function calculateSubsidy(plantKw) {
  if (plantKw <= 0) return 0;
  if (plantKw <= 1) return 30000;
  if (plantKw <= 2) return 50000;
  return 78000; // 3 kW and above
}
</script>

</body>
</html>
